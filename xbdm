#!/bin/bash
# xbdm_gdb_bridge launcher
# Reads configuration from xbdm_config.ini and connects to Xbox/xemu
#
# Usage:
#   ./xbdm                     # Interactive shell
#   ./xbdm -- dmversion        # Run single command
#   ./xbdm -s -- gdb :1999     # Start GDB server, keep shell open
#   ./xbdm 192.168.1.100       # Override IP from config

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BINARY="$SCRIPT_DIR/xbdm_gdb_bridge_linux"
CONFIG_FILE="$SCRIPT_DIR/xbdm_config.ini"

# Default values
XBOX_IP=""
XBDM_PORT="731"

# Parse config file if it exists
if [[ -f "$CONFIG_FILE" ]]; then
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue

        # Trim whitespace
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)

        case "$key" in
            xbox_ip) XBOX_IP="$value" ;;
            xbdm_port) XBDM_PORT="$value" ;;
        esac
    done < "$CONFIG_FILE"
fi

# Check if first argument looks like an IP address (override config)
if [[ "$1" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+ ]]; then
    XBOX_IP="$1"
    shift
fi

# Validate we have an IP
if [[ -z "$XBOX_IP" ]]; then
    echo "Error: No Xbox/xemu IP address configured."
    echo ""
    echo "Either:"
    echo "  1. Run setup.ps1 (Windows) to create configuration"
    echo "  2. Create xbdm_config.ini with xbox_ip = <your_ip>"
    echo "  3. Pass IP as argument: ./xbdm 192.168.1.77"
    echo ""
    exit 1
fi

# Check binary exists
if [[ ! -f "$BINARY" ]]; then
    echo "Error: xbdm_gdb_bridge_linux binary not found at:"
    echo "  $BINARY"
    echo ""
    echo "You may need to build it or download a release."
    exit 1
fi

# Make sure it's executable
chmod +x "$BINARY"

# Build connection string
CONNECTION="$XBOX_IP"
if [[ "$XBDM_PORT" != "731" ]]; then
    CONNECTION="$XBOX_IP:$XBDM_PORT"
fi

# Run the bridge
exec "$BINARY" "$CONNECTION" "$@"
